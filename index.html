<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAA ENGINEERING LINK HUB - SECURE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        html { scroll-behavior: smooth; }
        .sidebar-bg, .login-bg {
            background-color: #222629;
            background-image: url('https://res.cloudinary.com/dzgov6mcu/image/upload/v1770112701/Gemini_Generated_Image_avn34iavn34iavn3_k2ry12.png');
            background-blend-mode: overlay;
            background-size: cover;
            background-position: center; 
        }
        .dark-overlay { background-color: rgba(0, 0, 0, 0.75); }
        
        @keyframes slide-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }

        .dashboard-card {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(75, 85, 99, 0.4);
            transition: all 0.3s ease;
        }
        .dashboard-card:hover {
            border-color: rgba(96, 165, 250, 0.6);
            transform: translateY(-2px);
            background: rgba(31, 41, 55, 0.8);
        }

        /* Custom Scrollbar for Red Eye Card */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1); 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(96, 165, 250, 0.5); 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(96, 165, 250, 0.8); 
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans text-gray-600 bg-white overflow-hidden h-screen">

    <!-- ================= LOGIN SCREEN (VISIBLE BY DEFAULT) ================= -->
    <div id="login-screen" class="fixed inset-0 z-[100] login-bg flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-80"></div>
        
        <div class="relative z-10 bg-gray-900 bg-opacity-90 p-8 rounded-2xl shadow-2xl max-w-md w-full border border-gray-700 text-center backdrop-blur-md">
            <div class="mb-6 flex justify-center">
                <img src="https://res.cloudinary.com/dzgov6mcu/image/upload/v1770126241/logomaa_wwii3a.png" 
                     alt="MAA Logo" 
                     class="w-24 h-24 rounded-full border-4 border-gray-600 shadow-lg object-cover">
            </div>
            
            <h1 class="text-2xl font-bold text-white mb-1">MAA ENGINEERING</h1>
            <p class="text-gray-400 text-sm mb-8 tracking-widest uppercase">Secured Access Portal</p>

            <div id="login-error" class="hidden bg-red-500 bg-opacity-20 border border-red-500 text-red-200 p-3 rounded mb-4 text-xs text-left">
                <i class="fa-solid fa-circle-exclamation mr-1"></i> <span id="error-msg">Error</span>
            </div>

            <button id="google-login-btn" class="w-full bg-white text-gray-800 font-bold py-3 px-4 rounded-lg flex items-center justify-center hover:bg-gray-100 transition shadow-lg group">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 mr-3" alt="Google">
                Sign in with Google
            </button>
            
            <div id="loading-indicator" class="hidden flex justify-center items-center py-3">
                <div class="loader mr-2"></div>
                <span class="text-white text-sm">Verifying Credentials...</span>
            </div>

            <p class="mt-6 text-xs text-gray-500">
                Restricted access for <span class="text-gray-300">@airasia.com</span> only.
            </p>
        </div>
    </div>

    <!-- ================= EXPORT MODAL (HIDDEN BY DEFAULT) ================= -->
    <div id="export-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-lg w-11/12 max-w-2xl border border-gray-600 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-900">
                <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-file-export mr-2 text-purple-400"></i> Export Data (Plain Text)</h3>
                <button onclick="closeExportModal()" class="text-gray-400 hover:text-white transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="p-0 flex-1 overflow-hidden relative">
                <textarea id="export-textarea" class="w-full h-64 md:h-96 bg-gray-900 text-green-400 font-mono text-xs p-4 border-none resize-none focus:ring-0 outline-none leading-relaxed" readonly></textarea>
            </div>
            <div class="p-4 border-t border-gray-700 bg-gray-900 flex justify-end space-x-3">
                <button onclick="copyExportData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-semibold transition flex items-center">
                    <i class="fa-regular fa-copy mr-2"></i> Copy to Clipboard
                </button>
                <button onclick="closeExportModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm font-semibold transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- ================= APP CONTENT (HIDDEN BY DEFAULT) ================= -->
    <div id="app-content" class="hidden flex-col md:flex-row h-screen w-full overflow-hidden">
        
        <!-- MOBILE MENU BUTTON -->
        <button id="mobile-menu-btn" class="fixed top-4 left-4 z-[60] text-white bg-gray-800 bg-opacity-80 p-3 rounded-md md:hidden hover:bg-gray-700 transition shadow-lg border border-gray-600">
            <i class="fa-solid fa-bars text-xl"></i>
        </button>

        <!-- SIDEBAR -->
        <div id="header" class="fixed inset-y-0 left-0 w-64 h-screen sidebar-bg text-white shadow-2xl z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
            <div class="dark-overlay w-full h-full flex flex-col">
                
                <!-- Sidebar Header -->
                <div class="p-6 text-right flex flex-col items-end">
                    <div class="mb-4">
                        <img src="https://res.cloudinary.com/dzgov6mcu/image/upload/v1770126241/logomaa_wwii3a.png" 
                             alt="MAA Logo" 
                             class="w-16 h-16 rounded-full border-2 border-gray-500 ml-auto object-cover">
                    </div>
                    <h1 class="text-xl font-bold leading-tight">MAA</h1>
                    <h1 class="text-xl font-bold leading-tight text-gray-300">ENGINEERING</h1>
                    <h1 class="text-xs font-light tracking-widest mt-1 text-gray-400">MOC LINKS HUB</h1>
                    <p class="text-[10px] text-green-400 mt-2 font-mono"><i class="fa-solid fa-signal"></i> Live System</p>
                </div>

                <!-- Nav Links -->
                <nav class="flex-1 overflow-y-auto px-6 py-2">
                    <ul class="space-y-4 text-right">
                        <li>
                            <a href="#projects" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline">Projects</span>
                                <i class="fa-solid fa-shuttle-space text-lg w-6 text-center"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.google.com/spreadsheets/d/1feAD2dXpGe6V_55qVL0AdpghzPQ2_mnlSE5H21xNkL8/edit?gid=1352464537#gid=1352464537" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline text-[11px]">HANDOVER SHEET</span>
                                <i class="fa-solid fa-file-signature text-lg w-6 text-center"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.google.com/spreadsheets/d/1mN4E5cXsxGxsloWB8NGPsJMU0OIL0ANO1CgnbNSh0gU/edit?gid=1459300150#gid=1459300150" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline text-[11px]">COMAT SHEET</span>
                                <i class="fa-solid fa-boxes-packing text-lg w-6 text-center"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.google.com/spreadsheets/d/10LFoNKmrFMcwXQmzfbszxhQu7R8fBZrzGQFgM7tfnNg/edit?gid=1291803062#gid=1291803062" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline text-[11px]">REQUEST ENS</span>
                                <i class="fa-solid fa-file-circle-check text-lg w-6 text-center"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://docs.google.com/spreadsheets/d/1v1NaHf5eas1atch8cM_sM0WEjcPuCdFGaw9uXMB0VVk/edit?gid=1145119591#gid=1145119591" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline text-[11px]">STN MAINT SUPPORT</span>
                                <i class="fa-solid fa-screwdriver-wrench text-lg w-6 text-center"></i>
                            </a>
                        </li>
                          <li>
                            <a href="https://docs.google.com/spreadsheets/d/1jbs6zWsTG0zDChbgdWTWRr0oAncYi6pHkqQRFLNT4oA/edit?gid=1673954076#gid=1673954076" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline text-[11px]">MOC ROSTER</span>
                                <i class="fa-solid fa-file-circle-check text-lg w-6 text-center"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://elevade.io" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline">ELEVADE</span>
                                <i class="fa-solid fa-arrow-up-right-dots text-lg w-6 text-center"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://w3.airbus.com/H380/world/airbusworld/forms/airbus.fcc" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline">AIRBUS WORLD</span>
                                <i class="fa-solid fa-earth-europe text-lg w-6 text-center"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://vdiairfase.airasia.com/RDWeb/webclient/" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline">AIRFASE</span>
                                <i class="fa-solid fa-jet-fighter text-lg w-6 text-center"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://redwatch.airasia.com/eops#" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline">RED WATCH</span>
                                <i class="fa-solid fa-bullseye text-lg w-6 text-center"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://skyaims.airasia.com" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline">AIMS</span>
                                <i class="fa-solid fa-crosshairs text-lg w-6 text-center"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbzWpwTbW9jYYO-knwIqrg4Hb5bgnlx5eJwenYRyOwUWxCtMslgtzzsgGgfdsw2RQzHg/exec" target="_blank" class="group flex items-center justify-end space-x-3 text-gray-400 hover:text-white transition">
                                <span class="text-sm uppercase tracking-wide group-hover:underline text-[11px]">ELH OLD VERSION</span>
                                <i class="fa-solid fa-clock-rotate-left text-lg w-6 text-center"></i>
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- User Profile Section -->
                <div class="p-4 border-t border-gray-700 bg-black bg-opacity-30">
                    <div class="flex items-center justify-between mb-2">
                        <img id="user-photo" src="" alt="User" class="w-8 h-8 rounded-full border border-gray-500">
                        <div class="text-right">
                            <div id="user-name" class="text-xs font-bold text-white truncate max-w-[120px]">User</div>
                            <div id="user-email" class="text-[10px] text-gray-400 truncate max-w-[120px]">@airasia.com</div>
                        </div>
                    </div>
                    <button id="logout-btn" class="w-full text-xs bg-red-600 hover:bg-red-500 text-white py-1 px-2 rounded transition flex items-center justify-center">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT SCROLLABLE AREA -->
        <div id="main" class="flex-1 w-full md:ml-64 transition-all duration-300 overflow-y-auto h-full">

            <!-- Banner & Dashboard Section (FIXED FOR MOBILE) -->
            <section id="top" class="relative w-full min-h-[500px] flex items-center">
                <!-- Background Image Absolute -->
                <div class="absolute inset-0 z-0">
                    <img src="https://res.cloudinary.com/dzgov6mcu/image/upload/v1770126320/banner_sq0hej.jpg" 
                         alt="Banner" 
                         class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-75"></div>
                </div>

                <!-- Content Relative (Allows expansion) -->
                <div class="relative z-10 container mx-auto px-6 py-20 md:py-10">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl md:text-4xl font-bold text-white drop-shadow-lg uppercase tracking-wider">
                            MOC <span class="text-blue-400">ENGINEERING</span> DASHBOARD
                        </h2>
                        <div class="h-1 w-24 bg-blue-500 mx-auto mt-4 rounded-full"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        
                        <!-- Card 1: DDML REPORT -->
                        <div class="dashboard-card p-5 rounded-2xl text-white relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-2 opacity-50"><i class="fa-solid fa-file-invoice text-4xl text-gray-500"></i></div>
                            
                            <div class="flex items-center justify-between mb-2 relative z-10">
                                <div class="bg-blue-600 bg-opacity-40 p-1.5 rounded-lg"><i class="fa-solid fa-clipboard-list text-blue-200 text-sm"></i></div>
                                <span id="ddml-date" class="text-[10px] font-mono text-blue-300 border border-blue-500/30 px-2 py-0.5 rounded bg-blue-900/40">Syncing...</span>
                            </div>
                            
                            <div class="relative z-10">
                                <div class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">Total DDML</div>
                                <div class="flex items-end">
                                    <div id="ddml-total" class="text-4xl font-bold text-white leading-none">--</div>
                                    <div id="ddml-trend" class="ml-3 mb-1 text-sm font-bold flex items-center"></div>
                                </div>
                            </div>

                            <div class="mt-4 pt-3 border-t border-gray-600/50 grid grid-cols-3 gap-2 text-center relative z-10">
                                <div>
                                    <div class="text-[9px] text-gray-400 uppercase">CAT</div>
                                    <div id="ddml-cat" class="text-lg font-bold text-yellow-400">-</div>
                                    <div id="ddml-cat-trend" class="text-[10px] h-4 flex items-center justify-center font-bold"></div>
                                </div>
                                <div class="border-l border-gray-600/50">
                                    <div class="text-[9px] text-gray-400 uppercase">AMD</div>
                                    <div id="ddml-amd" class="text-lg font-bold text-green-400">-</div>
                                    <div id="ddml-amd-trend" class="text-[10px] h-4 flex items-center justify-center font-bold"></div>
                                </div>
                                <div class="border-l border-gray-600/50">
                                    <div class="text-[9px] text-gray-400 uppercase">STR/FC</div>
                                    <div id="ddml-str" class="text-lg font-bold text-red-400">-</div>
                                    <div id="ddml-str-trend" class="text-[10px] h-4 flex items-center justify-center font-bold"></div>
                                </div>
                            </div>
                            <div class="mt-2 text-[8px] text-gray-500 text-center relative z-10">
                                Refer from MAA AIRCRAFT STATUS EMAIL
                            </div>
                        </div>

                        <!-- Card 2 (Graph) -->
                        <div class="dashboard-card p-5 rounded-2xl text-white col-span-1 min-h-[240px] flex flex-col">
                            <div class="flex items-center justify-between mb-2">
                                <div class="bg-green-500 bg-opacity-20 p-2 rounded-lg"><i class="fa-solid fa-chart-line text-green-400"></i></div>
                                <span id="otp-trend" class="text-[9px] font-mono text-blue-300 px-1 border border-blue-500 rounded uppercase tracking-tighter">CONNECTING...</span>
                            </div>
                            <div class="flex-1 min-h-[140px] relative">
                                <canvas id="otpChart"></canvas>
                            </div>
                            <div class="mt-2 flex items-center justify-between text-[10px]">
                                <div class="flex items-center space-x-2">
                                    <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                                    <span class="text-gray-400 uppercase">OTP15</span>
                                    <span class="w-2 h-2 rounded-full bg-red-400 ml-2"></span>
                                    <span class="text-gray-400 uppercase">ENG DLY</span>
                                </div>
                                <div id="otp-value" class="text-lg font-bold text-blue-400 leading-none">--.--%</div>
                            </div>
                        </div>

                        <!-- Card 3: RED EYE FLIGHT (UPDATED) -->
                        <div class="dashboard-card p-5 rounded-2xl text-white h-[240px] flex flex-col relative group">
                            <!-- EXPORT BUTTON -->
                            <button onclick="exportRedEyeData()" class="absolute top-2 right-2 text-gray-400 hover:text-white transition opacity-0 group-hover:opacity-100 p-1" title="Export Data">
                                <i class="fa-solid fa-file-export text-xs"></i>
                            </button>

                            <div class="flex items-center justify-between mb-3 shrink-0 mr-4">
                                <div class="bg-purple-500 bg-opacity-20 p-2 rounded-lg flex items-center gap-2">
                                    <i class="fa-solid fa-moon text-purple-400"></i>
                                </div>
                                <span class="text-[10px] font-mono text-purple-300 uppercase tracking-widest text-right">RED EYE FLIGHT<br><span class="text-[9px] text-gray-400">04:00 - 09:00</span></span>
                            </div>
                            
                            <!-- Header Row (Updated to 4 cols: REG, FLT, FROM, STA) -->
                            <div class="grid grid-cols-4 gap-1 mb-2 text-[9px] font-bold text-gray-400 border-b border-gray-600 pb-1 shrink-0">
                                <div class="text-center">REG</div>
                                <div class="text-center">FLT</div>
                                <div class="text-center">FROM</div> 
                                <div class="text-center">STA</div>  
                            </div>

                            <!-- Scrollable List -->
                            <div id="redeye-list" class="flex-1 overflow-y-auto custom-scrollbar relative">
                                <!-- Loading State -->
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                                    <div class="loader w-4 h-4 mb-2 border-2 border-purple-400 border-t-transparent"></div>
                                    <span class="text-[10px]">Loading...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Card 4: 36 HRS CHK DUE (NEW) -->
                        <div class="dashboard-card p-5 rounded-2xl text-white h-[240px] flex flex-col relative group">
                            <!-- EXPORT BUTTON -->
                            <button onclick="export36HrsData()" class="absolute top-2 right-2 text-gray-400 hover:text-white transition opacity-0 group-hover:opacity-100 p-1" title="Export Data">
                                <i class="fa-solid fa-file-export text-xs"></i>
                            </button>

                            <div class="flex items-center justify-between mb-3 shrink-0 mr-4">
                                <div class="bg-orange-500 bg-opacity-20 p-2 rounded-lg flex items-center gap-2">
                                    <i class="fa-solid fa-clock text-orange-400"></i>
                                </div>
                                <span class="text-[10px] font-mono text-orange-300 uppercase tracking-widest text-right">36 HRS CHK DUE<br><span class="text-[9px] text-gray-400">MONITORING</span></span>
                            </div>
                            
                            <!-- Header Row -->
                            <div class="grid grid-cols-3 gap-1 mb-2 text-[9px] font-bold text-gray-400 border-b border-gray-600 pb-1 shrink-0">
                                <div class="col-span-1 text-left pl-2">REG</div>
                                <div class="col-span-2 text-right pr-2">REMAINING</div>
                            </div>

                            <!-- Scrollable List -->
                            <div id="36hrs-list" class="flex-1 overflow-y-auto custom-scrollbar relative">
                                <!-- Loading State -->
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                                    <div class="loader w-4 h-4 mb-2 border-2 border-orange-400 border-t-transparent"></div>
                                    <span class="text-[10px]">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Projects Section -->
            <section id="projects" class="pt-8 pb-20 bg-gray-100">
                <div class="container mx-auto px-6 max-w-7xl">
                    <header class="mb-10 border-b pb-4">
                        <h2 class="text-3xl font-bold text-gray-800"><i class="fa-solid fa-shuttle-space mr-2 text-gray-400"></i> Projects</h2>
                    </header>

                    <div id="project-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        
                        <!-- 1. DELAY CAPTURE -->
                        <article class="bg-white rounded-lg shadow-md hover:shadow-xl transition relative group">
                            <div onclick="toggleProjectMenu('menu-delay')" class="cursor-pointer block h-64 overflow-hidden rounded-t-lg outline-none relative">
                                <img src="https://res.cloudinary.com/dzgov6mcu/image/upload/v1770129978/delay_qu18ng.png" class="w-full h-full object-cover transform transition duration-500 hover:scale-110" alt="DELAY">
                                <div id="menu-delay" onclick="event.stopPropagation()" class="hidden md:group-hover:flex absolute bottom-0 left-0 w-full h-full bg-black bg-opacity-85 px-6 animate-slide-up flex-col justify-center items-center space-y-2">
                                    <a href="https://docs.google.com/spreadsheets/d/15hzmr796muPK4Qg24eo1PDX9r8MGYwcEa_wWEOaTYsI/edit?pli=1&gid=1575409481#gid=1575409481" target="_blank" class="w-full text-center py-2 px-4 bg-green-600 text-white rounded hover:bg-green-500 transition font-semibold shadow-md text-sm border border-green-400"><i class="fa-brands fa-google mr-2"></i> GOOGLE SHEET DATA</a>
                                    <a href="https://docs.google.com/spreadsheets/d/1-aHRMHSciihQUT8CnDdZWIQo4_KlSUAZs3fcoYyDbNs/edit?gid=1650993066#gid=1650993066" target="_blank" class="w-full text-center py-2 px-4 bg-purple-600 text-white rounded hover:bg-purple-500 transition font-semibold shadow-md text-sm border border-purple-400"><i class="fa-solid fa-file-excel mr-2"></i> SHEET (MOCF/03 REV02)</a>
                                    <a href="https://drive.google.com/file/d/1wcVMkCYR9xSXM9DaDJDYv9GZU_nrBNoQ/view?usp=sharing" target="_blank" class="w-full text-center py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-500 transition font-semibold shadow-md text-sm border border-blue-400"><i class="fa-solid fa-file-contract mr-2"></i> TUTORIAL VDO</a> 
                                </div>
                            </div>
                            <div class="p-6"><h3 class="font-bold text-lg">DELAY CAPTURE & EDSR DRAFT</h3></div>
                        </article>

                        <!-- 2. 36HRS -->
                        <article class="bg-white rounded-lg shadow-md hover:shadow-xl transition relative group">
                            <div onclick="toggleProjectMenu('menu-36hrs')" class="cursor-pointer block h-64 overflow-hidden rounded-t-lg outline-none relative">
                                <img src="https://res.cloudinary.com/dzgov6mcu/image/upload/v1770129380/36hrweekly_cymzfd.png" class="w-full h-full object-cover transform transition duration-500 hover:scale-110" alt="36HRS">
                                <div id="menu-36hrs" onclick="event.stopPropagation()" class="hidden md:group-hover:flex absolute bottom-0 left-0 w-full h-full bg-black bg-opacity-85 px-6 animate-slide-up flex-col justify-center items-center space-y-2">
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbwtfXs0ElPqbXRe47Q44D9YER3op9Mj_ToAyPtgi-To_6pVrAJtId-2BpVMsWGRNeYg/exec" target="_blank" class="w-full text-center py-2 px-4 bg-orange-600 text-white rounded hover:bg-orange-500 transition font-semibold shadow-md text-sm border border-orange-400"><i class="fa-solid fa-calendar-days mr-2"></i> PLANNER + GANTT</a>
                                </div>
                            </div>
                            <div class="p-6"><h3 class="font-bold text-lg">36HRS & WEEKLY</h3></div>
                        </article>

                        <!-- 3. COCKPIT -->
                        <article class="bg-white rounded-lg shadow-md hover:shadow-xl transition relative group">
                            <div onclick="toggleProjectMenu('menu-cockpit')" class="cursor-pointer block h-64 overflow-hidden rounded-t-lg outline-none relative">
                                <img src="https://res.cloudinary.com/dzgov6mcu/image/upload/v1770479842/WINDOWS_UD_ox67ko.jpg" class="w-full h-full object-cover transform transition duration-500 hover:scale-110" alt="COCKPIT">
                                <div id="menu-cockpit" onclick="event.stopPropagation()" class="hidden md:group-hover:flex absolute bottom-0 left-0 w-full h-full bg-black bg-opacity-85 px-6 animate-slide-up flex-col justify-center items-center space-y-2">
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbzANRaZP38ZfMW-u285DYCOfbzZW6446bk4JoiVNSYCkPc3c5XTDXWvKgXRQ4XuesMd/exec" target="_blank" class="w-full text-center py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-500 transition font-semibold shadow-md text-sm border border-blue-400"><i class="fa-solid fa-file-contract mr-2"></i> REPORT FORM</a>
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbxMPlhgrnzNndvr7tJfU2T2gd0o_ZjxiOcy8rHvk5RDbMp5YDpGThhEis13qZuN_WJuIg/exec" target="_blank" class="w-full text-center py-2 px-4 bg-teal-600 text-white rounded hover:bg-teal-500 transition font-semibold shadow-md text-sm border border-teal-400"><i class="fa-solid fa-eye mr-2"></i> VIEW REPORT</a>
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbxvislr4mcYrl6og6M-InSr4xpuSpgTBCD7sGgkwLlmui9TJCLBnM-2vL9ER_njUMm5/exec" target="_blank" class="w-full text-center py-2 px-4 bg-purple-600 text-white rounded hover:bg-purple-500 transition font-semibold shadow-md text-sm border border-purple-400"><i class="fa-solid fa-chart-line mr-2"></i> SUMMARY BOARD</a>
                                    <a href="https://docs.google.com/spreadsheets/d/16AUNk-n2xzs-HE3nQJp52QLkPjyxOfPh3JNNrSrz-GM/edit?usp=sharing" target="_blank" class="w-full text-center py-2 px-4 bg-green-600 text-white rounded hover:bg-green-500 transition font-semibold shadow-md text-sm border border-green-400"><i class="fa-brands fa-google mr-2"></i> GOOGLE SHEET DATA</a>
                                </div>
                            </div>
                            <div class="p-6"><h3 class="font-bold text-lg">COCKPIT WINDOWS</h3></div>
                        </article>

                        <!-- 4. FUEL -->
                        <article class="bg-white rounded-lg shadow-md hover:shadow-xl transition relative group">
                            <div onclick="toggleProjectMenu('menu-fuel')" class="cursor-pointer block h-64 overflow-hidden rounded-t-lg outline-none relative">
                                <img src="https://res.cloudinary.com/dzgov6mcu/image/upload/v1770130942/fuel_bbbev9.png" class="w-full h-full object-cover transform transition duration-500 hover:scale-110" alt="FUEL">
                                <div id="menu-fuel" onclick="event.stopPropagation()" class="hidden md:group-hover:flex absolute bottom-0 left-0 w-full h-full bg-black bg-opacity-85 px-6 animate-slide-up flex-col justify-center items-center space-y-2">
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbz1bMuKjwUm7hG6z2nRfc5kTYVAaRkjS6Lj-6wZueOme3OgqKctYPQxYegZJD4G4h8_/exec" target="_blank" class="w-full text-center py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-500 transition font-semibold shadow-md text-sm border border-blue-400"><i class="fa-solid fa-file-contract mr-2"></i> REPORT FORM</a>
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbxM3fGeCoxjC7bhZxb2jJZu3hnkpWRRhRqBI4mR8CeWAwtUNe8mEksMxKStD5ZuYPfzPg/exec" target="_blank" class="w-full text-center py-2 px-4 bg-purple-600 text-white rounded hover:bg-purple-500 transition font-semibold shadow-md text-sm border border-purple-400"><i class="fa-solid fa-chart-line mr-2"></i> SUMMARY BOARD</a>
                                    <a href="https://docs.google.com/spreadsheets/d/1dERSv5F9Vz-bQv-010ResmCJ7-kI8zggnG3aqFXZ_1o/edit?gid=1917141521#gid=1917141521" target="_blank" class="w-full text-center py-2 px-4 bg-green-600 text-white rounded hover:bg-green-500 transition font-semibold shadow-md text-sm border border-green-400"><i class="fa-brands fa-google mr-2"></i> GOOGLE SHEET DATA</a>
                                    <a href="https://docs.google.com/spreadsheets/d/1ct0ydAJXArnnMRaFuYK5H5kbKYhGO7NABT5dHkY1rJg/edit?gid=0#gid=0" target="_blank" class="w-full text-center py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-500 transition font-semibold shadow-md text-sm border border-gray-400"><i class="fa-solid fa-database mr-2"></i> TODAY's back-up</a>
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbwUcSU5dHqMmb8MBv8z0z2tzjRHcgII1V9DFV6tGAsc8e6Pu8Ylb7RdR-JHrLkJzuKrIA/exec" target="_blank" class="w-full text-center py-2 px-4 bg-cyan-600 text-white rounded hover:bg-cyan-500 transition font-semibold shadow-md text-sm border border-cyan-400"><i class="fa-solid fa-plane-arrival mr-2"></i> KUL Bay Planner</a>
                                </div>
                            </div>
                            <div class="p-6"><h3 class="font-bold text-lg">FUEL DRAIN MONITOR</h3></div>
                        </article>

                        <!-- 5. OIL -->
                        <article class="bg-white rounded-lg shadow-md hover:shadow-xl transition relative group">
                            <div onclick="toggleProjectMenu('menu-oil')" class="cursor-pointer block h-64 overflow-hidden rounded-t-lg outline-none relative">
                                <img src="https://res.cloudinary.com/dzgov6mcu/image/upload/v1770139005/oil_hhq1wf.png" class="w-full h-full object-cover transform transition duration-500 hover:scale-110" alt="OIL">
                                <div id="menu-oil" onclick="event.stopPropagation()" class="hidden md:group-hover:flex absolute bottom-0 left-0 w-full h-full bg-black bg-opacity-85 px-6 animate-slide-up flex-col justify-center items-center space-y-2">
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbweXIls6u4khtDxFAZr3rA7jGIBkp1qQmeB5iy8accP0eyhmAOzpaoVlAqBxoME3faL/exec" target="_blank" class="w-full text-center py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-500 transition font-semibold shadow-md text-sm border border-blue-400"><i class="fa-solid fa-file-contract mr-2"></i> REPORT FORM</a>
                                    <a href="https://docs.google.com/spreadsheets/d/1FMlo_qZ-Aon1iSTPSThb3fEEuGJewM8s3NoIP8eXCL8/edit?gid=0#gid=0" target="_blank" class="w-full text-center py-2 px-4 bg-green-600 text-white rounded hover:bg-green-500 transition font-semibold shadow-md text-sm border border-green-400"><i class="fa-brands fa-google mr-2"></i> GOOGLE SHEET DATA</a>
                                </div>
                            </div>
                            <div class="p-6"><h3 class="font-bold text-lg">ENG OIL SERVICING</h3></div>
                        </article>

                        <!-- 6. STARTER -->
                        <article class="bg-white rounded-lg shadow-md hover:shadow-xl transition relative group">
                            <div onclick="toggleProjectMenu('menu-starter')" class="cursor-pointer block h-64 overflow-hidden rounded-t-lg outline-none relative">
                                <img src="https://res.cloudinary.com/dzgov6mcu/image/upload/v1770131568/Starter_rql29z.png" class="w-full h-full object-cover transform transition duration-500 hover:scale-110" alt="STARTER">
                                <div id="menu-starter" onclick="event.stopPropagation()" class="hidden md:group-hover:flex absolute bottom-0 left-0 w-full h-full bg-black bg-opacity-85 px-6 animate-slide-up flex-col justify-center items-center space-y-2">
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbxB33Fwh9gdmOniqlOsmCbjGRl4WYxW5963GMvudMfrt1ZHyeN-hqPFec1BeRH8vAgd/exec" target="_blank" class="w-full text-center py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-500 transition font-semibold shadow-md text-sm border border-blue-400"><i class="fa-solid fa-file-contract mr-2"></i> REPORT FORM</a>
                                    <a href="https://docs.google.com/spreadsheets/d/1VxuFhBMkuXdi1N_JncPG0do8P2Hn4mxbr1PdWkQMPC0/edit?gid=1042130743#gid=1042130743" target="_blank" class="w-full text-center py-2 px-4 bg-green-600 text-white rounded hover:bg-green-500 transition font-semibold shadow-md text-sm border border-green-400"><i class="fa-brands fa-google mr-2"></i> GOOGLE SHEET DATA</a>
                                    <a href="https://lookerstudio.google.com/u/0/reporting/0a50c273-b14c-49cf-84c8-551d0f2cb4c3/page/dwbcF" target="_blank" class="w-full text-center py-2 px-4 bg-purple-600 text-white rounded hover:bg-purple-500 transition font-semibold shadow-md text-sm border border-purple-400"><i class="fa-solid fa-chart-line mr-2"></i> SUMMARY BOARD</a>
                                </div>
                            </div>
                            <div class="p-6"><h3 class="font-bold text-lg">PNEUMATIC STARTER</h3></div>
                        </article>

                        <!-- 7. SPINNER -->
                        <article class="bg-white rounded-lg shadow-md hover:shadow-xl transition relative group">
                            <div onclick="toggleProjectMenu('menu-spinner')" class="cursor-pointer block h-64 overflow-hidden rounded-t-lg outline-none relative">
                                <img src="https://res.cloudinary.com/dzgov6mcu/image/upload/v1770133170/Screenshot_2569-02-03_at_23.38.50_xyxagd.png" class="w-full h-full object-cover transform transition duration-500 hover:scale-110" alt="SPINNER">
                                <div id="menu-spinner" onclick="event.stopPropagation()" class="hidden md:group-hover:flex absolute bottom-0 left-0 w-full h-full bg-black bg-opacity-85 px-6 animate-slide-up flex-col justify-center items-center space-y-2">
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbxzBqHE0vcoXpWV4NI1ba3H9pTS4IRzvxiuuVG-qEoE/dev" target="_blank" class="w-full text-center py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-500 transition font-semibold shadow-md text-sm border border-blue-400"><i class="fa-solid fa-file-contract mr-2"></i> REPORT FORM</a>
                                    <a href="https://script.google.com/a/macros/airasia.com/s/AKfycbx3XdGe19vjxDN91kZ3I2owOJWmR_XFzt4uLH3djGC0zU4Ru5iZVxYq0vFPJtE0daQt8w/exec" target="_blank" class="w-full text-center py-2 px-4 bg-teal-600 text-white rounded hover:bg-teal-500 transition font-semibold shadow-md text-sm border border-teal-400"><i class="fa-solid fa-eye mr-2"></i> VIEW REPORT</a>
                                    <a href="https://docs.google.com/spreadsheets/d/1FYK35P9TaySA-4A8F5t04m3kTTaCeBIwJgDa874JKFg/edit?usp=sharing" target="_blank" class="w-full text-center py-2 px-4 bg-green-600 text-white rounded hover:bg-green-500 transition font-semibold shadow-md text-sm border border-green-400"><i class="fa-brands fa-google mr-2"></i> MAIN GG SHEET</a>
                                </div>
                            </div>
                            <div class="p-6"><h3 class="font-bold text-lg">ENG SPINNER CONE</h3></div>
                        </article>

                    </div>
                </div>
            </section>

            <footer class="bg-gray-200 py-6 text-center text-xs text-gray-500">
                &copy; jack & sonic. | Powered by MOC Tech
            </footer>
        </div>
    </div>

    <!-- MAIN APP SCRIPT WITH FIREBASE INTEGRATION -->
    <script type="module">
        // Import Firebase Functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ================================================================
        // [1] ส่วนตั้งค่า FIREBASE (คุณต้องแก้ไขตรงนี้)
        // ================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBoHj4s99iMQLKKT8ZZHD4uTugLXlQRxWg",
            authDomain: "maa-moc.firebaseapp.com",
            projectId: "maa-moc",
            storageBucket: "maa-moc.firebasestorage.app",
            messagingSenderId: "1025979944090",
            appId: "1:1025979944090:web:4e4408870e740fa34ba323",
            measurementId: "G-77MC6DQX0T"
        };

        // Initialize Firebase
        let app, auth, provider;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' }); 
            // REMOVED: Scope that caused the verification warning
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        const loginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorDiv = document.getElementById('login-error');
        const errorMsg = document.getElementById('error-msg');
        
        // User Profile Elements
        const userPhoto = document.getElementById('user-photo');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');

        // [2] LOGIN FUNCTION
        loginBtn.addEventListener('click', async () => {
            errorDiv.classList.add('hidden');
            loginBtn.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // REMOVED: Token capture logic as we removed the scope

                validateUser(user);
            } catch (error) {
                console.error(error);
                showLoginError(error.message);
            }
        });

        // [3] VALIDATION LOGIC
        function validateUser(user) {
            if (user.email.endsWith('@airasia.com')) {
                showApp(user);
            } else {
                signOut(auth);
                showLoginError("Access Denied: Only @airasia.com accounts are allowed.");
            }
        }

        function showApp(user) {
            userName.innerText = user.displayName || "User";
            userEmail.innerText = user.email;
            if(user.photoURL) userPhoto.src = user.photoURL;

            loginScreen.classList.add('hidden');
            appContent.classList.remove('hidden');
            appContent.classList.add('flex');
            
            if(!window.chartInterval) {
                fetchOTPData();
                fetchDDMLData();
                fetchRedEyeData();
                fetch36HrsData(); // NEW: Fetch 36HRS data
                window.chartInterval = setInterval(() => {
                    fetchOTPData();
                    fetchDDMLData();
                    fetchRedEyeData();
                    fetch36HrsData(); // NEW: Fetch 36HRS data loop
                }, 60000);
            }
        }

        function showLoginError(message) {
            loadingIndicator.classList.add('hidden');
            loginBtn.classList.remove('hidden');
            errorDiv.classList.remove('hidden');
            errorMsg.innerText = message;
        }

        // [4] AUTH STATE OBSERVER (SECURE MODE)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.email.endsWith('@airasia.com')) {
                    showApp(user);
                } else {
                    signOut(auth);
                }
            } else {
                // Not logged in
                loginScreen.classList.remove('hidden');
                appContent.classList.add('hidden');
                appContent.classList.remove('flex');
            }
        });

        // [5] LOGOUT FUNCTION
        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                location.reload();
            }).catch((error) => {
                console.error('Logout Error:', error);
            });
        });

        // --- DASHBOARD JS ---
        
        // Mobile Menu
        const btn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('header');
        btn.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));
        
        window.closeMobileMenu = function() { 
            if (window.innerWidth < 768) sidebar.classList.add('-translate-x-full'); 
        }

        // Toggle Project Menu
        window.toggleProjectMenu = function(menuId) {
            if (window.innerWidth >= 768) return;
            
            const menu = document.getElementById(menuId);
            if (!menu) return;
            
            const allMenus = document.querySelectorAll('[id^="menu-"]');
            allMenus.forEach(m => {
                if (m.id !== menuId) {
                    m.classList.add('hidden');
                    m.classList.remove('flex');
                }
            });

            menu.classList.toggle('hidden');
            menu.classList.toggle('flex');
        }

        // --- EXPORT FUNCTIONALITY ---
        window.closeExportModal = function() {
            document.getElementById('export-modal').classList.add('hidden');
        };

        window.exportRedEyeData = function() {
            const listContainer = document.getElementById('redeye-list');
            const rows = listContainer.querySelectorAll('.grid');
            let text = "RED EYE FLIGHT REPORT (04:00 - 09:00)\n";
            text += "--------------------------------------------------\n";
            text += "REG     | FLT     | FROM    | STA  \n";
            text += "--------------------------------------------------\n";

            rows.forEach(row => {
                const cols = row.querySelectorAll('div');
                if (cols.length === 4) {
                    const reg = cols[0].innerText.padEnd(8);
                    const flt = cols[1].innerText.padEnd(8);
                    const from = cols[2].innerText.padEnd(8);
                    const sta = cols[3].innerText;
                    text += `${reg}| ${flt}| ${from}| ${sta}\n`;
                }
            });
            text += "--------------------------------------------------\n";
            text += "Generated by MAA Engineering Link Hub";

            const textarea = document.getElementById('export-textarea');
            textarea.value = text;
            document.getElementById('export-modal').classList.remove('hidden');
        };

        // NEW: Export Function for 36 HRS
        window.export36HrsData = function() {
            const listContainer = document.getElementById('36hrs-list');
            const rows = listContainer.querySelectorAll('.grid');
            let text = "36 HRS CHECK DUE MONITORING\n";
            text += "----------------------------------------\n";
            text += "REG     | REMAINING TIME \n";
            text += "----------------------------------------\n";

            rows.forEach(row => {
                const cols = row.querySelectorAll('div');
                if (cols.length >= 2) {
                    const reg = cols[0].innerText.padEnd(8);
                    const remaining = cols[1].innerText;
                    text += `${reg}| ${remaining}\n`;
                }
            });
            text += "----------------------------------------\n";
            text += "Generated by MAA Engineering Link Hub";

            const textarea = document.getElementById('export-textarea');
            textarea.value = text;
            document.getElementById('export-modal').classList.remove('hidden');
        };

        window.copyExportData = function() {
            const textarea = document.getElementById('export-textarea');
            textarea.select();
            document.execCommand('copy');
            
            const btn = document.querySelector('#export-modal button i.fa-copy').parentElement;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        };

        // --- FETCH DDML DATA FROM SHEET ---
        async function fetchDDMLData() {
            const SHEET_ID = '1D9ed8aGAIWbf_MmfN_Lm4b2s9ZkBETnaQ6u06gobil0';
            const SHEET_NAME = 'ชีต1';
            const RANGE = 'A2:E5'; 
            const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&range=${RANGE}`;

            try {
                const res = await fetch(URL);
                const text = await res.text();
                
                // Parse GViz JSON response
                const jsonText = text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonText);
                
                // Check if data exists
                if (json.table && json.table.rows.length > 0) {
                    // --- Row 2 Data (Main Data) ---
                    const mainRow = json.table.rows[0].c;
                    const dateVal = mainRow[0] ? (mainRow[0].f || mainRow[0].v) : 'N/A';
                    const catVal = mainRow[1] ? (mainRow[1].f || mainRow[1].v) : '0';
                    const amdVal = mainRow[2] ? (mainRow[2].f || mainRow[2].v) : '0';
                    const strVal = mainRow[3] ? (mainRow[3].f || mainRow[3].v) : '0';
                    const totalVal = mainRow[4] ? (mainRow[4].f || mainRow[4].v) : '0';

                    // Update Main UI
                    document.getElementById('ddml-date').textContent = dateVal;
                    document.getElementById('ddml-total').textContent = totalVal;
                    document.getElementById('ddml-cat').textContent = catVal;
                    document.getElementById('ddml-amd').textContent = amdVal;
                    document.getElementById('ddml-str').textContent = strVal;

                    // --- Summary Row Data (Trend Data) ---
                    let trendRow = null;
                    
                    for(let i = 1; i < json.table.rows.length; i++) {
                        const r = json.table.rows[i].c;
                        if (r && r[0] && r[0].v && String(r[0].v).toLowerCase().trim() === 'summary') {
                            trendRow = r;
                            break;
                        }
                    }

                    // Fallback
                    if (!trendRow && json.table.rows.length > 1) {
                         trendRow = json.table.rows[json.table.rows.length - 1].c;
                    }

                    const generateTrendHTML = (cellData) => {
                        if (cellData && cellData.v !== null) {
                            const val = parseFloat(cellData.v);
                            const absVal = Math.abs(val);

                            if (val > 0) {
                                return `<i class="fa-solid fa-arrow-down text-green-400 mr-1" style="font-size: 8px;"></i> <span class="text-green-400">${absVal}</span>`;
                            } else if (val < 0) {
                                return `<i class="fa-solid fa-arrow-up text-red-400 mr-1" style="font-size: 8px;"></i> <span class="text-red-400">${absVal}</span>`;
                            } else {
                                return `<span class="text-gray-500">-</span>`;
                            }
                        }
                        return '';
                    };

                    if (trendRow) {
                        document.getElementById('ddml-trend').innerHTML = generateTrendHTML(trendRow[4]);
                        document.getElementById('ddml-cat-trend').innerHTML = generateTrendHTML(trendRow[1]);
                        document.getElementById('ddml-amd-trend').innerHTML = generateTrendHTML(trendRow[2]);
                        document.getElementById('ddml-str-trend').innerHTML = generateTrendHTML(trendRow[3]);
                    }
                }
            } catch (error) {
                console.error("Error fetching DDML:", error);
                document.getElementById('ddml-date').textContent = "Offline";
            }
        }

        // --- FETCH RED EYE DATA ---
        async function fetchRedEyeData() {
            // Sheet ID: 1CEGBX67w-EucpDNWsZBcpEs5G3ZmmqICp8oLdlzKo9c
            const SHEET_ID = '1CEGBX67w-EucpDNWsZBcpEs5G3ZmmqICp8oLdlzKo9c';
            const GID = '0';
            const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}&headers=1`;
            const listContainer = document.getElementById('redeye-list');

            try {
                const res = await fetch(URL);
                if (!res.ok) { throw new Error(`HTTP Status: ${res.status}`); }
                const text = await res.text();
                const jsonText = text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonText);
                let html = '';
                
                if (json.table && json.table.rows.length > 0) {
                    json.table.rows.forEach(row => {
                        const r = row.c;
                        if (!r) return;
                        const reg = r[0] ? (r[0].f || r[0].v || '') : '';
                        const flt = r[1] ? (r[1].f || r[1].v || '') : '';
                        const from = r[2] ? (r[2].f || r[2].v || '') : ''; 
                        let sta = r[3] ? (r[3].f || r[3].v || '') : '';   

                        if (reg.toLowerCase().includes('reg') || reg.toLowerCase().includes('ทะเบียน')) return;
                        if (reg === '' && flt === '') return;

                        html += `
                            <div class="grid grid-cols-4 gap-1 py-1.5 border-b border-gray-700/50 hover:bg-white/5 transition px-1">
                                <div class="text-center text-[10px] font-mono text-purple-300">${reg}</div>
                                <div class="text-center text-[10px] text-gray-300">${flt}</div>
                                <div class="text-center text-[10px] text-gray-400 truncate">${from}</div>
                                <div class="text-center text-[10px] font-bold text-white">${sta}</div>
                            </div>
                        `;
                    });
                } else {
                    html = '<div class="text-center text-xs text-gray-500 py-4">No Data</div>';
                }
                listContainer.innerHTML = html;
            } catch (error) {
                console.error("Error fetching Red Eye Data:", error);
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="text-red-400 text-xs mb-2"><i class="fa-solid fa-lock mb-1"></i><br>Load Failed</div>
                        <a href="https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit?gid=${GID}" target="_blank" class="text-[9px] bg-gray-700 hover:bg-gray-600 text-white py-1 px-2 rounded border border-gray-500"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> Open Sheet</a>
                        <div class="mt-2 text-[8px] text-gray-500">*Must be "Anyone with link"</div>
                    </div>
                `;
            }
        }

        // --- NEW: FETCH 36HRS DATA ---
        async function fetch36HrsData() {
            // Sheet ID: 1X7VKdTDbFLcMRlfKIUvrTOi9dxSuvFsaA7qrixtEJ4I
            // Sheet Name: MAAA (Using sheet name parameter)
            // Column A: REG
            // Column B: Remaining Time
            const SHEET_ID = '1X7VKdTDbFLcMRlfKIUvrTOi9dxSuvFsaA7qrixtEJ4I';
            const SHEET_NAME = 'MAAA';
            // Use sheet name to be specific
            const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&headers=1`;
            const listContainer = document.getElementById('36hrs-list');

            try {
                const res = await fetch(URL);
                if (!res.ok) { throw new Error(`HTTP Status: ${res.status}`); }
                const text = await res.text();
                const jsonText = text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonText);
                let html = '';
                
                if (json.table && json.table.rows.length > 0) {
                    json.table.rows.forEach(row => {
                        const r = row.c;
                        if (!r) return;
                        
                        // A=0, B=1
                        const reg = r[0] ? (r[0].f || r[0].v || '') : '';
                        const remaining = r[1] ? (r[1].f || r[1].v || '') : '';

                        // Skip headers and empty rows
                        if (reg.toLowerCase().includes('reg') || reg.toLowerCase().includes('ทะเบียน')) return;
                        if (reg === '' && remaining === '') return;

                        // Check for negative value to maybe style it (optional, just simple display for now)
                        // If it contains '-', maybe make it red?
                        const textColorClass = remaining.includes('-') ? 'text-red-400' : 'text-orange-100';

                        html += `
                            <div class="grid grid-cols-3 gap-1 py-1.5 border-b border-gray-700/50 hover:bg-white/5 transition px-1">
                                <div class="col-span-1 text-left pl-2 text-[10px] font-mono text-orange-300 font-bold">${reg}</div>
                                <div class="col-span-2 text-right pr-2 text-[10px] font-bold ${textColorClass} truncate">${remaining}</div>
                            </div>
                        `;
                    });
                } else {
                    html = '<div class="text-center text-xs text-gray-500 py-4">No Data</div>';
                }
                listContainer.innerHTML = html;
            } catch (error) {
                console.error("Error fetching 36HRS Data:", error);
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="text-red-400 text-xs mb-2"><i class="fa-solid fa-lock mb-1"></i><br>Load Failed</div>
                        <a href="https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit" target="_blank" class="text-[9px] bg-gray-700 hover:bg-gray-600 text-white py-1 px-2 rounded border border-gray-500"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> Open Sheet</a>
                        <div class="mt-2 text-[8px] text-gray-500">*Must be "Anyone with link"</div>
                    </div>
                `;
            }
        }

        // Chart Logic
        const OPT_DATA_URL = 'https://script.google.com/macros/s/AKfycbzUXDItR3eFn_16B68oz953r_F1PgoQ4kUuyfivYEG0Gb1RGRvSyVd8nKqv9flIgx4x/exec';
        let otpChart = null;

        async function fetchOTPData() {
            const trendEl = document.getElementById('otp-trend');
            const valueEl = document.getElementById('otp-value');
            
            if (trendEl) {
                trendEl.textContent = 'SYNCING...';
                trendEl.classList.replace('text-green-400', 'text-yellow-400');
            }
            
            try {
                const response = await fetch(OPT_DATA_URL);
                if (!response.ok) throw new Error('Network error');
                
                const data = await response.json();

                // FILTER: Only include data points where the main value (OTP15/valueB) is significantly greater than 0
                const validData = data.filter(d => {
                    const val = parseFloat(d.valueB || d.value);
                    return !isNaN(val) && val > 0.001; // Strict filter for non-zero values
                });

                if (Array.isArray(validData) && validData.length > 0) {
                    const labels = validData.map(d => d.date);
                    
                    // Special processing for OTP (valueB) - needs to handle fractions
                    const processOTP = (val) => {
                        if (typeof val === 'string' && val.includes('%')) {
                            return parseFloat(val);
                        }
                        let n = parseFloat(val);
                        if (isNaN(n)) return 0;
                        return (n > 0 && n <= 1.0) ? (n * 100) : n;
                    };

                    // Special processing for ENG DLY (valueC)
                    const processEngDly = (val) => {
                        if (typeof val === 'string' && val.includes('%')) {
                            return parseFloat(val);
                        }
                        let n = parseFloat(val);
                        if (isNaN(n)) return 0;
                        return (n > 0 && n <= 0.05) ? (n * 100) : n; 
                    };

                    const valuesB = validData.map(d => processOTP(d.valueB || d.value));
                    const valuesC = validData.map(d => processEngDly(d.valueC || 0));

                    updateChart(labels, valuesB, valuesC);
                    
                    if (valueEl) {
                        const latestOTP15 = valuesB[valuesB.length - 1];
                        valueEl.textContent = latestOTP15.toFixed(2) + '%';
                    }
                    
                    if (trendEl) {
                        trendEl.textContent = 'DUAL ONLINE';
                        trendEl.classList.replace('text-yellow-400', 'text-green-400');
                    }
                }
            } catch (err) {
                console.error('Fetch error:', err);
                if (trendEl) {
                    trendEl.textContent = 'RETRYING...';
                    trendEl.classList.replace('text-green-400', 'text-red-400');
                    trendEl.classList.replace('text-yellow-400', 'text-red-400');
                }
            }
        }

        function updateChart(labels, valuesB, valuesC) {
            const canvas = document.getElementById('otpChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            if (otpChart) {
                otpChart.data.labels = labels;
                otpChart.data.datasets[0].data = valuesB;
                otpChart.data.datasets[1].data = valuesC;
                otpChart.update();
            } else {
                otpChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'OTP15 (%)',
                                data: valuesB,
                                borderColor: '#60a5fa',
                                backgroundColor: 'rgba(96, 165, 250, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'ENG DLY (%)',
                                data: valuesC,
                                borderColor: '#f87171',
                                backgroundColor: 'rgba(248, 113, 113, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        animation: { duration: 1000 },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleFont: { size: 10 },
                                bodyFont: { size: 10 },
                                callbacks: {
                                    label: (ctx) => `${ctx.dataset.label.split(' ')[0]}: ${ctx.parsed.y.toFixed(2)}%`
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: '#9ca3af', font: { size: 8 }, maxRotation: 0 }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(75, 85, 99, 0.2)', borderDash: [2, 4] },
                                ticks: { color: '#9ca3af', font: { size: 8 } } // Added ticks here
                            }
                        }
                    }
                });
            }
        }
        
        // Initial fetch call
        fetchOTPData();
        fetchDDMLData();
        fetchRedEyeData();
        fetch36HrsData();
    </script>
</body>
</html>
